<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">
    <link href='style.css' rel='stylesheet' type='text/css'>
    <title>Resultados - Teste Político 8 Valores</title>
    <link rel="icon" type="x-icon" href="icon.png">
    <link rel="shortcut icon" type="x-icon" href="icon.png">
    <script>
        version = "" 
    </script>
</head>
<body>
    <script type="application/javascript" src="ideologies.js"></script>

    <h1><a href="index.html" class="header-link">Teste Político 8 Valores</a></h1>
    <hr>

    <h1>Resultados</h1>

    <h2>Eixo Econômico: <span class="weight-300" id="economic-label"></span></h2>
    <div class="axis">
        <img id="img-equality" src="imagens/igualdade.png" alt="Ícone Igualdade" />
        <div class="bar-container"> 
             <div class="bar equality" id="bar-equality"><div class="text-wrapper" id="equality">?</div></div>
             <div class="bar wealth" id="bar-wealth"><div class="text-wrapper" id="wealth">?</div></div>
        </div>
        <img id="img-wealth" src="imagens/mercado.png" alt="Ícone Mercado" />
    </div>

    <h2>Eixo Diplomático: <span class="weight-300" id="diplomatic-label"></span></h2>
    <div class="axis">
        <img id="img-might" src="imagens/nacao.png" alt="Ícone Nação" />
         <div class="bar-container">
            <div class="bar might" id="bar-might"><div class="text-wrapper" id="might">?</div></div>
            <div class="bar peace" id="bar-peace"><div class="text-wrapper" id="peace">?</div></div>
        </div>
        <img id="img-peace" src="imagens/global.png" alt="Ícone Global" />
    </div>

    <h2>Eixo Civil: <span class="weight-300" id="state-label"></span></h2>
    <div class="axis">
        <img id="img-liberty" src="imagens/liberdade.png" alt="Ícone Liberdade" />
         <div class="bar-container">
            <div class="bar liberty" id="bar-liberty"><div class="text-wrapper" id="liberty">?</div></div>
            <div class="bar authority" id="bar-authority"><div class="text-wrapper" id="authority">?</div></div>
        </div>
        <img id="img-authority" src="imagens/autoridade.png" alt="Ícone Autoridade" />
    </div>

    <h2>Eixo Social: <span class="weight-300" id="society-label"></span></h2>
    <div class="axis">
        <img id="img-tradition" src="imagens/tradicao.png" alt="Ícone Tradição" />
         <div class="bar-container">
            <div class="bar tradition" id="bar-tradition"><div class="text-wrapper" id="tradition">?</div></div>
            <div class="bar progress" id="bar-progress"><div class="text-wrapper" id="progress">?</div></div>
        </div>
        <img id="img-progress" src="imagens/progresso.png" alt="Ícone Progresso" />
    </div>

    <h2>Correspondência Mais Próxima: <span class="weight-300" id="ideology-label">Calculando...</span></h2>

    <div class="ideology-details" style="display: none;">
        <div id="ideology-desc-container">
            <h3>Descrição</h3>
            <p id="ideology-desc">Carregando descrição...</p>
        </div>
        <div id="ideology-politicians-container" style="display: none;">
            <h3>Figuras Políticas Associadas</h3>
            <ul id="ideology-politicians-list"></ul>
            <p class="disclaimer">*As figuras listadas são exemplos associados à ideologia, podendo haver diferentes interpretações.</p>
        </div>
        <div id="ideology-books-container" style="display: none;">
            <h3>Leituras Recomendadas</h3>
            <ul id="ideology-books-list"></ul>
        </div>
    </div>

    <p class="instruction-text">Entender seu posicionamento político detalhado é o principal objetivo deste teste. Por isso, focamos nos 8 valores e seus eixos (Igualdade/Mercado, Nação/Global, Liberdade/Autoridade, Tradição/Progresso), como mostram os gráficos acima. Eles oferecem um panorama mais completo e com nuances das suas convicções. Encontrar um único rótulo ideológico que capture perfeitamente essa complexidade é difícil. Assim, a 'Correspondência Mais Próxima' é uma ferramenta ainda em desenvolvimento e deve ser vista como uma sugestão ou ponto de partida, sendo menos precisa que a análise dos seus eixos.</p>

    <hr/>

    <img src="" id="banner" alt="Banner com os resultados do teste" style="display: none;">

     <div class="button-container">
        <button id="copy-banner-button" class="button copy-button" style="display: none;">Copiar Imagem</button>
        <button class="button back-button" onclick="location.href='index.html';">Voltar</button>
    </div>

    <script>
         if (typeof ideologies !== 'undefined') {
            function getQueryVariable(variable) {
                const query = window.location.search.substring(1);
                const vars = query.split("&");
                for (let i = 0; i < vars.length; i++) {
                    const pair = vars[i].split("=");
                    if (decodeURIComponent(pair[0]) == variable) {
                        return decodeURIComponent(pair[1].replace(/\+/g, ' '));
                    }
                }
                return NaN;
            }

             function setBarValue(name, value) {
                const innerel = document.getElementById(name);
                const outerel = document.getElementById("bar-" + name);
                if (!innerel || !outerel) {
                     return;
                }

                const numValue = parseFloat(value);
                if (isNaN(numValue)) {
                     innerel.textContent = "?";
                     outerel.style.width = "0%";
                     innerel.style.visibility = "visible";
                     return;
                }

                const clampedValue = Math.max(0, Math.min(100, numValue));

                outerel.style.width = clampedValue + "%";
                innerel.textContent = clampedValue.toFixed(1) + "%";

                setTimeout(() => {
                    try {
                        if (outerel.offsetWidth === 0 || innerel.offsetWidth + 15 < outerel.offsetWidth) {
                             innerel.style.visibility = "visible";
                        } else {
                            innerel.style.visibility = "hidden";
                        }
                    } catch (e) {
                         innerel.style.visibility = "visible";
                    }
                }, 50);
            }

            const econArray = ["Comunista", "Socialista", "Social", "Centrista", "De Mercado", "Capitalista", "Laissez-Faire"];
            const diplArray = ["Cosmopolita", "Internacionalista", "Pacifista", "Equilibrado", "Patriótico", "Nacionalista", "Chauvinista"];
            const govtArray = ["Anarquista", "Libertário", "Liberal", "Moderado", "Estatista", "Autoritário", "Totalitário"];
            const sctyArray = ["Revolucionário", "Muito Progressista", "Progressista", "Neutro", "Tradicional", "Muito Tradicional", "Reacionário"];

            function setLabel(val, ary) {
                const numVal = parseFloat(val);
                 if (isNaN(numVal)) { return "Indefinido"; }
                if (numVal > 100) { return ""; }
                if (numVal > 90) { return ary[0]; }
                if (numVal > 75) { return ary[1]; }
                if (numVal > 60) { return ary[2]; }
                if (numVal >= 40) { return ary[3]; }
                if (numVal >= 25) { return ary[4]; }
                if (numVal >= 10) { return ary[5]; }
                if (numVal >= 0) { return ary[6]; }
                return "Indefinido";
            }

            const equality = parseFloat(getQueryVariable("e"));
            const peace = parseFloat(getQueryVariable("d"));
            const liberty = parseFloat(getQueryVariable("g"));
            const progress = parseFloat(getQueryVariable("s"));

            const wealth = !isNaN(equality) ? (100 - equality).toFixed(1) : NaN;
            const might = !isNaN(peace) ? (100 - peace).toFixed(1) : NaN;
            const authority = !isNaN(liberty) ? (100 - liberty).toFixed(1) : NaN;
            const tradition = !isNaN(progress) ? (100 - progress).toFixed(1) : NaN;

            setBarValue("equality", equality);
            setBarValue("wealth", wealth);
            setBarValue("peace", peace);
            setBarValue("might", might);
            setBarValue("liberty", liberty);
            setBarValue("authority", authority);
            setBarValue("progress", progress);
            setBarValue("tradition", tradition);

            document.getElementById("economic-label").innerHTML = setLabel(equality, econArray);
            document.getElementById("diplomatic-label").innerHTML = setLabel(peace, diplArray);
            document.getElementById("state-label").innerHTML = setLabel(liberty, govtArray);
            document.getElementById("society-label").innerHTML = setLabel(progress, sctyArray);

            let matchedIdeology = null;
            let ideologyName = "Indefinido";

            if (!isNaN(equality) && !isNaN(peace) && !isNaN(liberty) && !isNaN(progress)) {
                let ideodist = Infinity;
                for (let i = 0; i < ideologies.length; i++) {
                    let dist = 0;
                    dist += Math.pow(Math.abs(ideologies[i].stats.econ - equality), 2);
                    dist += Math.pow(Math.abs(ideologies[i].stats.govt - liberty), 2);
                    dist += Math.pow(Math.abs(ideologies[i].stats.dipl - peace), 1.73856063);
                    dist += Math.pow(Math.abs(ideologies[i].stats.scty - progress), 1.73856063);
                    if (dist < ideodist) {
                        matchedIdeology = ideologies[i];
                        ideologyName = ideologies[i].name;
                        ideodist = dist;
                    }
                }
            }
            document.getElementById("ideology-label").innerHTML = ideologyName;

            const descContainer = document.getElementById('ideology-desc-container');
            const descEl = document.getElementById('ideology-desc');
            const politiciansContainer = document.getElementById('ideology-politicians-container');
            const politiciansListEl = document.getElementById('ideology-politicians-list');
            const booksContainer = document.getElementById('ideology-books-container');
            const booksListEl = document.getElementById('ideology-books-list');
            const ideologyDetailsContainer = document.querySelector('.ideology-details');

            if (matchedIdeology) {
                 if(ideologyDetailsContainer) ideologyDetailsContainer.style.display = 'block';

                if (descEl) descEl.innerHTML = matchedIdeology.desc || "Nenhuma descrição disponível.";

                if (politiciansListEl && politiciansContainer && Array.isArray(matchedIdeology.politicians) && matchedIdeology.politicians.length > 0) {
                    politiciansListEl.innerHTML = '';
                    matchedIdeology.politicians.forEach(name => {
                        const li = document.createElement('li');
                        li.textContent = name;
                        politiciansListEl.appendChild(li);
                    });
                    politiciansContainer.style.display = 'block';
                } else if (politiciansContainer) {
                    politiciansContainer.style.display = 'none';
                }

                if (booksListEl && booksContainer && Array.isArray(matchedIdeology.books) && matchedIdeology.books.length > 0) {
                    booksListEl.innerHTML = '';
                    matchedIdeology.books.forEach(title => {
                        const li = document.createElement('li');
                        li.textContent = title;
                        booksListEl.appendChild(li);
                    });
                    booksContainer.style.display = 'block';
                } else if (booksContainer) {
                    booksContainer.style.display = 'none';
                }

            } else {
                if(ideologyDetailsContainer) ideologyDetailsContainer.style.display = 'none';
            }

            function generateCanvasBanner() {
                 try {
                    const c = document.createElement("canvas");
                    const ctx = c.getContext("2d");
                    c.width = 800;
                    c.height = 650;

                    ctx.fillStyle = "#EEEEEE";
                    ctx.fillRect(0, 0, c.width, c.height);

                    const imagesToLoad = [
                        { id: "img-equality", x: 20, y: 170, w: 100, h: 100 }, { id: "img-wealth", x: 680, y: 170, w: 100, h: 100 },
                        { id: "img-might", x: 20, y: 290, w: 100, h: 100 }, { id: "img-peace", x: 680, y: 290, w: 100, h: 100 },
                        { id: "img-liberty", x: 20, y: 410, w: 100, h: 100 }, { id: "img-authority", x: 680, y: 410, w: 100, h: 100 },
                        { id: "img-tradition", x: 20, y: 530, w: 100, h: 100 }, { id: "img-progress", x: 680, y: 530, w: 100, h: 100 }
                    ];

                    let loadPromises = [];

                    const drawRestOfCanvas = () => {
                        ctx.fillStyle = "#222222";
                        ctx.fillRect(120, 180, 560, 80); ctx.fillRect(120, 300, 560, 80);
                        ctx.fillRect(120, 420, 560, 80); ctx.fillRect(120, 540, 560, 80);

                        const barWidth = 5.6;
                        const drawBar = (valueStr, color, x, widthMultiplier, y, height) => {
                            const value = parseFloat(valueStr);
                            if (!isNaN(value)) {
                                const clampedVal = Math.max(0, Math.min(100, value));
                                ctx.fillStyle = color;
                                const calculatedWidth = barWidth * clampedVal * widthMultiplier - 2;
                                const finalX = (widthMultiplier === -1) ? x - (calculatedWidth > 0 ? calculatedWidth : 0) : x;
                                ctx.fillRect(finalX, y, calculatedWidth > 0 ? calculatedWidth : 0, height);
                            }
                        };
                        drawBar(equality, "#e63946", 120, 1, 184, 72);
                        drawBar(wealth, "#1d3557", 680, -1, 184, 72);
                        drawBar(might, "#f77f00", 120, 1, 304, 72);
                        drawBar(peace, "#a8dadc", 680, -1, 304, 72);
                        drawBar(liberty, "#ffc300", 120, 1, 424, 72);
                        drawBar(authority, "#457b9d", 680, -1, 424, 72);
                        drawBar(tradition, "#8338ec", 120, 1, 544, 72);
                        drawBar(progress, "#3a86ff", 680, -1, 544, 72);

                        ctx.fillStyle = "#222222"; ctx.font = "700 50px Poppins";
                        ctx.textAlign = "left"; ctx.textBaseline = "top";
                        ctx.fillText("Teste Político 8 Valores", 20, 25);
                        ctx.font = "400 40px Poppins";
                        ctx.fillText(ideologyName, 20, 85);

                        ctx.font = "900 30px Inter"; ctx.textBaseline = "middle";
                        const drawPercentageText = (valueStr, x, y, textAlign, barColor) => {
                             const value = parseFloat(valueStr);
                             if (!isNaN(value) && value > 30) {
                                ctx.textAlign = textAlign;
                                ctx.fillStyle = (barColor === '#ffc300' || barColor === '#a8dadc') ? '#222222' : '#ffffff';
                                ctx.shadowColor = (barColor === '#ffc300' || barColor === '#a8dadc') ? "rgba(255,255,255,0.5)" : "rgba(0,0,0,0.6)";
                                ctx.shadowBlur = (barColor === '#ffc300' || barColor === '#a8dadc') ? 2 : 3;
                                ctx.fillText(value.toFixed(1) + "%", x, y + 40);
                                ctx.shadowColor = "transparent"; ctx.shadowBlur = 0;
                            }
                        };
                        drawPercentageText(equality, 130, 180, "left", '#e63946');
                        drawPercentageText(might, 130, 300, "left", '#f77f00');
                        drawPercentageText(liberty, 130, 420, "left", '#ffc300');
                        drawPercentageText(tradition, 130, 540, "left", '#8338ec');
                        drawPercentageText(wealth, 670, 180, "right", '#1d3557');
                        drawPercentageText(peace, 670, 300, "right", '#a8dadc');
                        drawPercentageText(authority, 670, 420, "right", '#457b9d');
                        drawPercentageText(progress, 670, 540, "right", '#3a86ff');

                        ctx.fillStyle = "#222222"; ctx.font = "300 20px Poppins";
                        ctx.textAlign = "right"; ctx.textBaseline = "alphabetic";
                        if(typeof version !== 'undefined' && version) ctx.fillText(version, 780, 40);

                        ctx.font = "400 24px Poppins"; ctx.textAlign = "center";
                        ctx.fillText("Econômico: " + document.getElementById("economic-label").innerHTML, 400, 165);
                        ctx.fillText("Diplomático: " + document.getElementById("diplomatic-label").innerHTML, 400, 285);
                        ctx.fillText("Civil: " + document.getElementById("state-label").innerHTML, 400, 405);
                        ctx.fillText("Social: " + document.getElementById("society-label").innerHTML, 400, 525);

                        const bannerElement = document.getElementById("banner");
                        const copyButton = document.getElementById("copy-banner-button");
                        if (bannerElement) {
                            bannerElement.src = c.toDataURL('image/png');
                            bannerElement.style.display = 'block';
                            if (copyButton) copyButton.style.display = 'inline-block';
                        }
                    };

                    imagesToLoad.forEach(imgData => {
                        loadPromises.push(new Promise((resolve, reject) => {
                             const imgElement = document.getElementById(imgData.id);
                            if (imgElement) {
                                const loadImage = () => {
                                    try {
                                        ctx.drawImage(imgElement, imgData.x, imgData.y, imgData.w, imgData.h);
                                        resolve();
                                    } catch(e) {
                                        reject(e);
                                    }
                                };
                                if (imgElement.complete && imgElement.naturalHeight !== 0) {
                                     loadImage();
                                } else {
                                    imgElement.onload = loadImage;
                                    imgElement.onerror = () => {
                                        reject(new Error("Falha ao carregar " + imgData.id));
                                    };
                                }
                            } else {
                                reject(new Error("Elemento não encontrado: " + imgData.id));
                            }
                        }));
                    });

                    Promise.all(loadPromises)
                        .then(drawRestOfCanvas)
                        .catch(error => {
                            const bannerElement = document.getElementById("banner");
                             if(bannerElement) {
                                bannerElement.alt = "Erro ao gerar imagem dos resultados.";
                                bannerElement.style.display = 'none';
                            }
                        });

                } catch (e) {
                    const bannerElement = document.getElementById("banner");
                    if(bannerElement) {
                        bannerElement.alt = "Erro ao gerar imagem dos resultados.";
                        bannerElement.style.display = 'none';
                    }
                }
             }

            function dataURLtoBlob(dataurl) {
                 try {
                    const arr = dataurl.split(','), mimeMatch = arr[0].match(/:(.*?);/);
                    if (!mimeMatch) throw new Error("Formato de Data URL inválido");
                    const mime = mimeMatch[1], bstr = atob(arr[1]);
                    let n = bstr.length;
                    const u8arr = new Uint8Array(n);
                    while(n--){
                        u8arr[n] = bstr.charCodeAt(n);
                    }
                    return new Blob([u8arr], {type:mime});
                } catch (e) {
                    return null;
                }
            }

            function setupCopyButton() {
                const copyButton = document.getElementById('copy-banner-button');
                const bannerImage = document.getElementById('banner');

                if (!copyButton || !bannerImage) {
                    return;
                }

                copyButton.addEventListener('click', async () => {
                    const originalButtonText = 'Copiar Imagem';

                    if (!window.isSecureContext) {
                        alert('Erro: A cópia de imagens só funciona em páginas seguras (HTTPS) ou localhost.');
                        return;
                    }

                    if (!navigator.clipboard || !navigator.clipboard.write) {
                        alert('Seu navegador não suporta a função de copiar imagens diretamente.');
                        return;
                    }

                     if (!bannerImage.src || !bannerImage.src.startsWith('data:image/')) {
                        alert('Aguarde a imagem do banner ser completamente gerada antes de copiar.');
                        return;
                    }

                    copyButton.disabled = true;
                    copyButton.textContent = 'Copiando...';

                    try {
                        const blob = dataURLtoBlob(bannerImage.src);
                        if (!blob) throw new Error("Falha ao criar Blob da imagem.");

                        await navigator.clipboard.write([
                            new ClipboardItem({
                                [blob.type]: blob
                            })
                        ]);

                        copyButton.textContent = 'Copiado!';
                        setTimeout(() => {
                            copyButton.textContent = originalButtonText;
                            copyButton.disabled = false;
                        }, 2000);

                    } catch (err) {
                        alert(`Falha ao copiar a imagem.\nCausa provável: Permissão negada ou erro interno.\nDetalhe: ${err.message}`);
                        copyButton.textContent = 'Erro ao Copiar';
                         setTimeout(() => {
                            copyButton.textContent = originalButtonText;
                            copyButton.disabled = false;
                        }, 3500);
                    }
                });
            }

            window.addEventListener('load', () => {
                setTimeout(generateCanvasBanner, 250);
                setupCopyButton();
            });


        } else {
             document.body.innerHTML = `<h1>Erro</h1><p>Não foi possível carregar os dados necessários (${'ideologies.js'}). Verifique sua conexão ou contate o administrador.</p>`;
        }
    </script>

</body>
</html>
